<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCE Cloud Dashboard</title>
    <!-- Favicon as Data URI to avoid 404 and CSP issues -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>☁️</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #38bdf8;
            --success: #4ade80;
            --danger: #f87171;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 1px solid #334155;
            padding-bottom: 20px;
        }
        h1 { margin: 0; font-size: 1.5rem; }
        .status-badge {
            background: var(--card-bg);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            align-items: start;
        }
        .card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .card h3 { margin-top: 0; color: var(--text-secondary); font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .metric { font-size: 2rem; font-weight: 700; margin: 10px 0; }
        .sub-metric { font-size: 0.875rem; color: var(--text-secondary); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #334155; }
        th { color: var(--text-secondary); font-weight: 600; font-size: 0.875rem; }
        td { font-size: 0.9rem; }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        
        .refresh-timer { font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px; }
        canvas { width: 100% !important; height: 300px !important; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>CCE Public Dashboard</h1>
                <div class="refresh-timer">Last Updated: <span id="last-updated">Never</span></div>
            </div>
            <div class="status-badge" id="system-mode">MODE: LOADING...</div>
        </header>

        <div class="grid">
            <div class="card">
                <h3>Portfolio Value</h3>
                <div class="metric" id="portfolio-value">---</div>
                <div class="sub-metric">24h Change: <span id="change-24h">---</span></div>
            </div>
            <div class="card">
                <h3>Current State</h3>
                <div class="metric" id="current-state" style="font-size: 1.5rem;">---</div>
                <div class="sub-metric">System Version: <span id="sys-version">---</span></div>
            </div>
            <div class="card">
                <h3>Market Data</h3>
                <div class="metric" id="btc-price">---</div>
                <div class="sub-metric">Fear & Greed: <span id="fear-greed">---</span></div>
            </div>
            <div class="card">
                <h3>Long Term</h3>
                <div class="metric" id="total-return">---</div>
                <div class="sub-metric">Days Active: <span id="days-running">---</span></div>
            </div>
        </div>

        <div class="card" style="margin-bottom: 30px;">
            <h3>Performance History</h3>
            <canvas id="portfolioChart"></canvas>
        </div>

        <div class="card">
            <h3>Recent Trades</h3>
            <table id="trades-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Symbol</th>
                        <th>Side</th>
                        <th>Price</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="5" style="text-align:center; color: #94a3b8;">Loading trades...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let portfolioChart = null;

        async function fetchData() {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();
                updateDashboard(data);
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        function updateDashboard(data) {
            // System
            document.getElementById('system-mode').textContent = `MODE: ${data.system.mode || 'UNKNOWN'}`;
            document.getElementById('sys-version').textContent = data.system.version;
            
            // Stats
            const stats = data.stats || {};
            document.getElementById('portfolio-value').textContent = `$${(stats.portfolio_value || 0).toFixed(2)}`;
            
            // Calculate 24h Change from history if available
            if (data.history && data.history.length > 0) {
                const currentVal = stats.portfolio_value || 0;
                // Assuming history is sorted ASC, take the first point (oldest in the window)
                // In a real scenario, you'd find the point closest to 24h ago.
                const startVal = data.history[0].portfolio_value;
                const change = currentVal - startVal;
                const changePct = (change / startVal) * 100;
                
                const changeEl = document.getElementById('change-24h');
                changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePct.toFixed(2)}%)`;
                changeEl.className = change >= 0 ? 'text-green' : 'text-red';
            }

            document.getElementById('current-state').textContent = stats.current_state || 'IDLE';
            
            // Optional stats if available
            if (stats.btc_price) document.getElementById('btc-price').textContent = `$${stats.btc_price}`;
            if (stats.fear_greed) document.getElementById('fear-greed').textContent = stats.fear_greed;

            // Long Term Stats
            const totalRet = stats.total_return_pct || 0;
            const totalRetEl = document.getElementById('total-return');
            totalRetEl.textContent = `${totalRet >= 0 ? '+' : ''}${totalRet.toFixed(2)}%`;
            totalRetEl.className = `metric ${totalRet >= 0 ? 'text-green' : 'text-red'}`;
            document.getElementById('days-running').textContent = stats.days_running || 0;

            // Timestamp
            if (data.lastUpdated) {
                document.getElementById('last-updated').textContent = new Date(data.lastUpdated).toLocaleString();
            }

            // Trades
            const tbody = document.querySelector('#trades-table tbody');
            tbody.innerHTML = '';
            
            if (data.trades && data.trades.length > 0) {
                data.trades.forEach(trade => {
                    const row = document.createElement('tr');
                    const date = new Date(trade.timestamp).toLocaleTimeString();
                    const sideClass = trade.side === 'BUY' ? 'text-green' : 'text-red';
                    
                    row.innerHTML = `
                        <td>${date}</td>
                        <td>${trade.symbol}</td>
                        <td class="${sideClass}">${trade.side}</td>
                        <td>$${trade.price}</td>
                        <td>$${trade.value}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: #94a3b8;">No recent trades</td></tr>';
            }

            // Update Chart
            updateChart(data.history);
        }

        function updateChart(history) {
            if (!history || history.length === 0) return;

            const ctx = document.getElementById('portfolioChart').getContext('2d');
            const labels = history.map(h => new Date(h.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
            const values = history.map(h => h.portfolio_value);

            if (portfolioChart) {
                portfolioChart.data.labels = labels;
                portfolioChart.data.datasets[0].data = values;
                portfolioChart.update();
            } else {
                portfolioChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Portfolio Value ($)',
                            data: values,
                            borderColor: '#38bdf8',
                            backgroundColor: 'rgba(56, 189, 248, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                            y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            }
        }

        // Initial load and poll
        fetchData();
        setInterval(fetchData, 10000); // Refresh every 10s
    </script>
</body>
</html>